

name: Publish to jetbrains marketplace
on:
  release:
    types: [prereleased, released]

jobs:
  call-publish-workflow-lowest:
    uses: ./.github/workflows/publish-workflow.yml
    with:
      build-profile: lowest
      tag-name: ${{ github.event.release.tag_name }}
      changelog: ${{ github.event.release.body }}
    secrets: inherit
  call-publish-workflow-latest:
    needs: call-publish-workflow-lowest
    uses: ./.github/workflows/publish-workflow.yml
    with:
      build-profile: latest
      tag-name: ${{ github.event.release.tag_name }}
      changelog: ${{ github.event.release.body }}
    secrets: inherit
  call-publish-workflow-eap:
    needs: call-publish-workflow-latest
    uses: ./.github/workflows/publish-workflow.yml
    with:
      build-profile: eap
      tag-name: ${{ github.event.release.tag_name }}
      changelog: ${{ github.event.release.body }}
    secrets: inherit


  update-to-next-version:
    needs: [ call-publish-workflow-lowest,call-publish-workflow-latest,call-publish-workflow-eap ]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main branch
        uses: actions/checkout@v3
        with:
          ref: main
          token: ${{ secrets.GH_ADMIN_TOKEN }}

      # Update changelog file and commit to main
      - name: Patch Changelog in main branch
        if: ${{ steps.properties.outputs.changelog != '' }}
        env:
          CHANGELOG: ${{ steps.properties.outputs.changelog }}
        run: |
          ./gradlew --no-configuration-cache  --gradle-user-home=./.localhome --project-cache-dir=./.projectcache -PdoNotDownloadSources=true patchChangelog --release-note="$CHANGELOG"

      - name: Increment version
        run: |
          ./gradlew --no-configuration-cache  --gradle-user-home=./.localhome --project-cache-dir=./.projectcache -PdoNotDownloadSources=true  incrementSemanticVersionPatch 
          ./gradlew --no-configuration-cache  --gradle-user-home=./.localhome --project-cache-dir=./.projectcache -PdoNotDownloadSources=true  printSemanticVersion -q

      - name: Commit next version to main
        run: |
          VERSION=$(cat version.properties |grep "version="|cut -d= -f2)
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add version.properties
          git add CHANGELOG.md
          git commit -m "increment version after publish to ${VERSION} and update changelog"
          git push
