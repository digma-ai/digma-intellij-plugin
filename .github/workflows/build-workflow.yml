name: Build workflow

on:
  workflow_call:
    inputs:
      build-profile:
        required: true
        type: string
      ref-name:
        required: true
        type: string
      build-with-rider:
        required: true
        type: string

jobs:
  build:

    runs-on: ubuntu-22.04

    steps:

      - name: Debug
        run: echo "Building ref ${{ inputs.ref-name }} with profile ${{ inputs.build-profile }}"

      - name: Maximize build space
        uses: AdityaGarg8/remove-unwanted-software@v1
        with:
          remove-android: true
          remove-haskell: true

      - name: Fetch Sources
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref-name }}

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'corretto'

      - name: Setup dotnet
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: |
            8.0.301

      ## wrapper-validation-action fails too often with this error https://github.com/gradle/wrapper-validation-action/issues/40
      ## we don't need it because we usually don't have contributors replacing it
      #      - name: Validate Gradle wrapper
      #        uses: gradle/wrapper-validation-action@v1


      - name: Build Plugin
        if: ${{ inputs.build-with-rider != 'true' }}
        env:
          POSTHOG_TOKEN_URL: ${{ secrets.POSTHOG_TOKEN_URL }}
        run: ./gradlew clean test buildPlugin --no-configuration-cache -PbuildProfile=${{ inputs.build-profile }} -PbuildSearchableOptions=true

      - name: Build Plugin with Rider
        if: ${{ inputs.build-with-rider == 'true' }}
        env:
          POSTHOG_TOKEN_URL: ${{ secrets.POSTHOG_TOKEN_URL }}
        run: ./gradlew clean test buildPlugin --no-configuration-cache -PbuildWithRider=true -PbuildProfile=${{ inputs.build-profile }} -PbuildSearchableOptions=true

      - name: Export Version
        id: exportversion
        shell: bash
        run: |
          VERSION=$(cat version.properties |grep "version="|cut -d= -f2)
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

      - name: Find posthog url
        id: posthog
        shell: bash
        run: |
          IJ_RELEASE_NUMBER=$(echo "${{ inputs.build-profile }}"|cut -c 2-)
          cd ${{ github.workspace }}/build/libs
          FILENAME=`ls digma-intellij-plugin-${{ steps.exportversion.outputs.version }}+$IJ_RELEASE_NUMBER.jar`
          unzip -q "$FILENAME" -d content
          URL=$(cat ./content/posthog-token-url.txt)
          echo "url=${URL}" >> "$GITHUB_OUTPUT"

      - name: Debug posthog url
        if: ${{ steps.posthog.outputs.url == '' }}
        run: echo "posthog url is empty,failing build"

      - name: Verify posthog url exists
        if: ${{ steps.posthog.outputs.url == '' }}
        uses: actions/github-script@v7
        with:
          script: |
            core.setFailed('posthog url is empty')

      - name: Prepare Plugin Artifact
        if: ${{ inputs.build-with-rider != 'true' }}
        id: artifact
        shell: bash
        run: |
          cd ${{ github.workspace }}/build/distributions
          FILENAME=`ls *.zip`
          unzip "$FILENAME" -d content
          echo "filename=${FILENAME:0:-4}" >> "$GITHUB_OUTPUT"

      - name: Upload Artifact
        if: ${{ inputs.build-with-rider != 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.artifact.outputs.filename }}
          path: ./build/distributions/content/*/*
          retention-days: 5

      # Collect Tests Result of failed tests
      ##todo: add other modules test reports
      - name: Collect Tests Result
        if: ${{ inputs.build-with-rider != 'true' || failure() }}
        uses: actions/upload-artifact@v4
        with:
          name: tests-result-${{ inputs.build-profile }}
          path: ${{ github.workspace }}/ide-common/build/reports/tests
          retention-days: 5
